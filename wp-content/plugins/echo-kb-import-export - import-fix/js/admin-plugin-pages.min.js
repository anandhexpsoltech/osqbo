"use strict";jQuery(document).ready(function(e){function i(){e("#epie_license_check").html("");t("GET",{action:"epie_handle_license_request",command:"get_license_info"},"Retrieving license status. Please wait.")}function t(i,t,s){let r;e(".eckb-top-notice-message").html(""),e.ajax({type:i,dataType:"json",data:t,url:ajaxurl,beforeSend:function(e){o("show",s)}}).done(function(i){if((i=i||"").message||void 0===i.output)return void(r=i.message?i.message:n("","KB Import Export: Error occurred. Please try again later. (L01)","error"));let t=void 0!==i.output&&i.output?i.output:n("","Please reload the page and try again (L37).","error");e("#epie_license_check").html(t)}).fail(function(e,i,t){r=n("KB Import Export: Error occurred. Please try again later. (L02)",r=t?" ["+t+"]":"unknown error","error")}).always(function(){o("remove",""),r&&(e(".eckb-top-notice-message").replaceWith(r),e("html, body").animate({scrollTop:0},"slow"))})}function o(i,t){if("show"===i){let i='<div class="epkb-admin-dialog-box-loading"><div class="epkb-admin-dbl__header"><div class="epkb-admin-dbl-icon epkbfa epkbfa-hourglass-half"></div>'+(t?'<div class="epkb-admin-text">'+t+"</div>":"")+'</div></div><div class="epkb-admin-dialog-box-overlay"></div>';e("body").append(i)}else"remove"===i&&(e(".epkb-admin-dialog-box-loading").remove(),e(".epkb-admin-dialog-box-overlay").remove())}function n(e,i,t){return'<div class="eckb-top-notice-message"><div class="contents"><span class="'+t+'">'+(e?"<h4>"+e+"</h4>":"")+(i||"")+"</span></div></div>"}function s(i){let t="";c.info.success&&(t+=`\n\t\t\t\t<div class="epie-export-progress__row epie-export-progress__row--success">\n\t\t\t\t\t<div class="epie-export__title">${c.info.success}</div>\n\t\t\t\t\t<div class="epie-export__icon"><i class="epkbfa epkbfa-check-circle"></i></div>\n\t\t\t\t</div>\n\t\t\t`,i.find(".epie-progress__bar div").css({width:"100%"}),c.info.file?(i.find("#export_file_link").attr("href",c.info.file),i.find("#export_file_link").show()):i.find("#export_file_link").hide()),c.info.error&&(t+=`\n\t\t\t\t<div class="epie-export-progress__row epie-export-progress__row--error">\n\t\t\t\t\t<div class="epie-export__title">${c.info.error}</div>\n\t\t\t\t\t<div class="epie-export__icon"><i class="epkbfa epkbfa-exclamation-circle"></i></div>\n\t\t\t\t</div>\n\t\t\t`,e("#epie-content-export .epie-progress__bar").hide()),i.find(".epie-progress__log").html(t)}function r(e){l=0,a(e),e.find(".epie-data-status-log").html(""),e.find("#kb_post_link").hide(),e.find("input[name=import_file]").val(""),e.find('input[name="import_file"]').prop("disabled",!1),e.find("#epie-submit-prepare-action").show(),e.find("#epie-submit-import-action").hide(),e.find("#epie-submit-start-over-action").hide(),e.find(".epie-progress").hide(),e.find("input[name=import_action]").val("prepare-kb-import"),e.parent().find(".epie-import-steps__single-step").removeClass("epie-import-steps__single-step--active"),e.parent().find("#epie-step-1").addClass("epie-import-steps__single-step--active"),e.find(".epie-form-field-wrap").show(),e.find(".epie-form-field-intruction-wrap").show(),e.find(".epie-form-field-intruction-wrap").show(),e.parent().parent().find(".epie-form-field-intruction-wrap").show(),e.find(".epie-progress__bar").removeClass("epie-progress__bar-in-progress"),"undefined"!=typeof interval&&clearInterval(interval)}function p(i,t){return f&&void 0!==i.processed?(f=!1,void setTimeout(function(){!function(i,t,o,n){e(".epie-admin-dialog-box-status").remove(),e(".epie-admin-dialog-box-loading").remove(),e(".epie-admin-dialog-box-confirmation").remove(),e(".epie-admin-dialog-box-info").remove();let s=`\n\t\t\t<div class="epie-admin-dbc__footer">\n\t\t\t\t<div class="epie-admin-dbc__footer__accept">\n\t\t\t\t\t<span class="epie-admin-dbc__footer__accept__btn epie-dbc__footer__accept--success">${epie_vars.msg_ok}</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`,r='<div class="epie-admin-dialog-box-info"><div class="epie-admin-dbc__header">'+(i?"<h4>"+i+"</h4>":"")+'</div><div class="epie-admin-dbc__body">'+(t||"")+"</div>"+s+"</div>";e("body").append(r),e("body").one("click",function(){"function"==typeof o&&o(n),e(".epie-admin-dialog-box-info").remove()})}(epie_vars.msg_content_import,epie_vars.msg_imported_articles+i.processed,r,t)},100)):"object"==typeof i&&void 0!==i.error?(t.find("#epie-submit-start-over-action").show(),e("#epie-cancel-action").hide(),void t.find(".epie-progress__log").html(`\n\t\t\t\t<div class="epie-export-progress__row epie-export-progress__row--error">\n\t\t\t\t\t<div class="epie-export__icon"><i class="epkbfa epkbfa-exclamation-circle"></i></div>\n\t\t\t\t\t<div class="epie-export__title">${i.error}</div>\n\t\t\t\t</div>\n\t\t\t`)):null!=i&&void 0!=i.success&&""!=i.success?(t.find(".epie-progress__bar div").css({width:"100%"}),e("#epie-cancel-action").hide(),t.find(".epie-progress__log").html(i.success),t.find(".epie-data-status-log").html(i.response_html),t.find(".epie-progress__bar").removeClass("epie-progress__bar-in-progress"),t.find("input[name=import_action]").val("prepare-kb-import"),t.find("#kb_post_link").show(),t.find('input[name="import_file"]').prop("disabled",!1),t.find(".epie-form-label__input--submit").hide(),t.find("#epie-submit-import-action").hide(),t.find("#epie-submit-start-over-action").show(),void(l=i.inserted)):(null!=i&&void 0!=i.process_message&&""!=i.process_message&&(t.find(".epie-progress__log .epie-export-progress__row--in-progress .epie-export__title").html(`\n\t\t\t\t${i.process_message}\n\t\t\t`),t.find(".epie-progress__bar-in-progress div").css({width:i.progress+"%"}),l=i.processed),void(_?function(i){_--,e.ajax({type:"POST",dataType:"json",data:{action:"epie_import_steps"},url:ajaxurl,beforeSend:function(e){}}).done(function(e){p(e,i)})}(t):(t.find("#epie-submit-start-over-action").show(),t.find(".epie-progress__log").html('\n\t\t\t\t<div class="epie-export-progress__row epie-export-progress__row--error">\n\t\t\t\t\t<div class="epie-export__icon"><i class="epkbfa epkbfa-exclamation-circle"></i></div>\n\t\t\t\t\t<div class="epie-export__title">The import file is too big.</div>\n\t\t\t\t</div>\n\t\t\t'))))}function a(e){let i=e.find(".epie-progress").data("start");e.find(".epie-progress__log").html(`\n\t\t\t<div class="epie-export-progress__row epie-export-progress__row--in-progress">\n\t\t\t\t<div class="epie-export__title">${i}</div>\n\t\t\t\t<div class="epie-export__icon"><i class="epkbfa epkbfa-spinner"></i></div>\n\t\t\t</div>\n\t\t`)}e("#epie-ajax-in-progress").dialog({resizable:!1,height:70,width:200,modal:!1,autoOpen:!1}).hide(),e(".epie-admin-dbc__close").on("click",function(){e(".epie-admin-dialog-box-confirmation").hide(),e(".epie-admin-dialog-box-info").remove()}),e(".epie-admin-dbc__footer__cancel").on("click",function(){e(".epie-admin-dialog-box-confirmation").hide(),e(".epie-admin-dialog-box-info").remove()}),e(".epie-tm-dbf__close").on("click",function(){e(".epie-tm-dialog-box-form").hide()}),e(".epie-tm-dbf__footer__cancel").on("click",function(){e(".epie-tm-dialog-box-form").hide()});let d=e("#ekcb-licenses");e("#eckb_license_tab").hasClass("active")&&i(),e("#wpbody").on("click","#eckb_license_tab",function(e){i()}),d.on("click","#epie_save_btn",function(i){i.preventDefault();t("POST",{action:"epie_handle_license_request",epie_license_key:e("#epie_license_key").val().trim(),_wpnonce_epie_license_key:e("#_wpnonce_epie_license_key").val(),command:"save"},"Saving license...")});let c={data:{},info:{items_per_request:5,success:"",error:"",in_progress:!1,file:"",file_id:""},user_data:{}};e("#export-main-form").submit(function(i){i.preventDefault();var t=e(this);t.find(".epie-progress").show(),function(i){let t={_wpnonce_kb_import_export:i.find("#_wpnonce_kb_import_export").val(),action:"epie_get_export_data",form:i.serialize()};var o=`\n\t\t\t\t\t<div class="epie-export-progress__row epie-export-progress__row--in-progress">\n\t\t\t\t\t\t<div class="epie-export__title">${i.find(".epie-progress").data("start")}</div>\n\t\t\t\t\t\t<div class="epie-export__icon"><i class="epkbfa epkbfa-spinner"></i></div>\n\t\t\t\t\t</div>`;i.find(".epie-progress__log").html(o),e.ajax({type:"POST",dataType:"json",data:t,url:ajaxurl,beforeSend:function(e){i.find(".epie-progress").show()}}).done(function(e){e.error?(c.info.error=e.error,s(i)):e.success&&(c.info.success=e.success,c.info.file=e.file,s(i))})}(t)}),e(".epie-top-panel__button").click(function(){e(".epie-top-panel__button").removeClass("epie-top-panel__button--active"),e(this).addClass("epie-top-panel__button--active"),e(".epie-content").removeClass("epie-content--active"),e(e(this).data("target")).addClass("epie-content--active")});let l=0,_=1e3,f=!1;e(".epie-import-content-form form").submit(function(i){i.preventDefault(),f=!1;let t=e(this);if("epie-submit-start-over-action"==i.originalEvent.submitter.id)return void r(t);const o=t.find("input[name=import_file]")[0].files[0],s=new FileReader;s.readAsText(o,"UTF-8"),s.onload=function(i){t.find('input[name="import_file"]').prop("disabled",!0),t.parents(".epkb-admin-row").addClass("epie-admin-row--import-kb-articles");let o="",s=new FormData;if(s.append("file",t.find("input[name=import_file]")[0].files[0]),s.append("_wpnonce_kb_import_export",t.find("#_wpnonce_kb_import_export").val()),s.append("epie_kb_id",t.find("input[name=epie_kb_id]").val()),s.append("import_action",t.find("input[name=import_action]").val()),s.append("action","epie_import_kb_content"),"prepare-kb-import"==t.find("input[name=import_action]").val())t.find("#epie-submit-prepare-action").hide(),t.find("#kb_post_link").hide(),t.parent().find(".epie-import-steps__single-step").removeClass("epie-import-steps__single-step--active"),t.parent().find("#epie-step-2").addClass("epie-import-steps__single-step--active"),t.find(".epie-form-field-wrap").hide(),t.find(".epie-form-field-intruction-wrap").hide(),t.parent().parent().find(".epie-form-field-intruction-wrap").hide(),a(t);else{if("import_data"!=t.find("input[name=import_action]").val())return;{t.find("#epie-submit-import-action").hide(),t.find("#epie-submit-start-over-action").hide(),t.parent().find(".epie-import-steps__single-step").removeClass("epie-import-steps__single-step--active"),t.parent().find("#epie-step-3").addClass("epie-import-steps__single-step--active");let i=[];t.find("input[name=csv_row]:checked").each(function(){i.push(e(this).val())}),s.append("selected_rows",JSON.stringify(i)),_=1e3,t.find(".epie-progress__bar").addClass("epie-progress__bar-in-progress"),a(t),t.find(".epie-progress__log .epie-export-progress__row--in-progress .epie-export__title").html(`\n\t\t\t\t\t${epie_vars.msg_0_imported} ${i.length}...\n\t\t\t\t`)}}t.find(".epie-progress").show(),t.find(".epie-progress__bar div").css({width:"0%"}),t.find(".epie-data-status-log").html(""),e.ajax({_wpnonce_kb_import_export:e(this).find("#_wpnonce_kb_import_export").val(),type:"POST",dataType:"json",data:s,url:ajaxurl,processData:!1,contentType:!1,beforeSend:function(i){"import_data"==t.find("input[name=import_action]").val()&&e("#epie-cancel-action").show()}}).done(function(e){if(""==(e=e||"")||"undefined"===e.success&&"undefined"===e.error&&"undefined"===e.process_message)return o=e.message?e.message:n("",epie_vars.msg_admin_error_l01,"error"),void t.find(".epie-data-status-log").html(o);void 0!=e.success&&""!=e.success&&"prepare-kb-import"==t.find("input[name=import_action]").val()?(t.find(".epie-progress__log").html(e.success),t.find(".epie-data-status-log").html(e.response_html),t.find(".epie-progress__bar div").css({width:"100%"}),t.find("input[name=import_action]").val("import_data"),t.find('input[name="import_file"]').prop("disabled",!0),t.find("#epie-submit-prepare-action").hide(),t.find("#epie-submit-import-action").show(),t.find("#epie-submit-start-over-action").show()):"import_data"==t.find("input[name=import_action]").val()?p(e,t):(t.find("#epie-submit-start-over-action").show(),t.find(".epie-progress__log").html(`\n\t\t\t\t\t<div class="epie-export-progress__row epie-export-progress__row--error">\n\t\t\t\t\t\t<div class="epie-export__icon"><i class="epkbfa epkbfa-exclamation-circle"></i></div>\n\t\t\t\t\t\t<div class="epie-export__title">${e.error}</div>\n\t\t\t\t\t</div>\n\t\t\t\t`)),void 0!==e.inserted&&e.inserted&&(l=e.inserted)}).fail(function(e,i,s){o=s?" ["+s+"]":"unknown error",o=n("",epie_vars.msg_admin_error_l012,"error"),t.find(".epie-data-status-log").html(o)})},s.onerror=function(e){t.find("input[name=import_file]").val(""),r(t),t.find(".epie-progress").show(),t.find(".epie-progress__log").html('\n\t\t\t\t\t<div class="epie-export-progress__row epie-export-progress__row--error">\n\t\t\t\t\t\t<div class="epie-export__icon"><i class="epkbfa epkbfa-exclamation-circle"></i></div>\n\t\t\t\t\t\t<div class="epie-export__title">Your CSV file has changed. Please reselect the file and start again.</div>\n\t\t\t\t\t</div>\n\t\t\t\t'),console.log(e)}}),e("#epie-cancel-action").click(function(){return f=!0,e("body").find(".epie-export__title").html(epie_vars.msg_stop_import),e(this).hide(),!1})});