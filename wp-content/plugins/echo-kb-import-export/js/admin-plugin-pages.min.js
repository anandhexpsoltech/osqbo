"use strict";jQuery(document).ready(function(e){function i(i,t){e(".epie-admin-dialog-box-status").hasClass("epie-admin-dialog-box-status--success")&&e(".epie-admin-dialog-box-status").remove(),e(".epie-admin-dialog-box-status").hasClass("epie-admin-dialog-box-status--info")&&e(".epie-admin-dialog-box-status").remove(),e(".epie-admin-dialog-box-loading").remove();let o='<div class="epie-bottom-notice-message epie-bottom-notice-message--'+t+'">'+(i||"")+"</div>";e("body").append(o),setTimeout(function(){e(".epie-bottom-notice-message").addClass("fadeOutDown")},3e3)}function t(){e("#epie_license_check").html("");o("GET",{action:"epie_handle_license_request",command:"get_license_info"},"Retrieving license status. Please wait.")}function o(i,t,o){let a;e(".eckb-top-notice-message").html(""),e.ajax({type:i,dataType:"json",data:t,url:ajaxurl,beforeSend:function(e){n("show",o)}}).done(function(i){if((i=i||"").message||void 0===i.output)return void(a=i.message?i.message:r("","KB Import Export: Error occurred. Please try again later. (L01)","error"));let t=void 0!==i.output&&i.output?i.output:r("","Please reload the page and try again (L37).","error");e("#epie_license_check").html(t)}).fail(function(e,i,t){a=r("KB Import Export: Error occurred. Please try again later. (L02)",a=t?" ["+t+"]":"unknown error","error")}).always(function(){n("remove",""),a&&(e(".eckb-top-notice-message").replaceWith(a),e("html, body").animate({scrollTop:0},"slow"))})}function n(i,t){if("show"===i){let i='<div class="epkb-admin-dialog-box-loading"><div class="epkb-admin-dbl__header"><div class="epkb-admin-dbl-icon epkbfa epkbfa-hourglass-half"></div>'+(t?'<div class="epkb-admin-text">'+t+"</div>":"")+'</div></div><div class="epkb-admin-dialog-box-overlay"></div>';e("body").append(i)}else"remove"===i&&(e(".epkb-admin-dialog-box-loading").remove(),e(".epkb-admin-dialog-box-overlay").remove())}function r(e,i,t){return'<div class="eckb-top-notice-message"><div class="contents"><span class="'+t+'">'+(e?"<h4>"+e+"</h4>":"")+(i||"")+"</span></div></div>"}function a(){let i="",t=0,o=0;if(m.info.success&&(i+=`\n\t\t\t\t<div class="epie-export-progress__row epie-export-progress__row--success">\n\t\t\t\t\t<div class="epie-export__title">${m.info.success}</div>\n\t\t\t\t\t<div class="epie-export__icon"><i class="epkbfa epkbfa-check-circle"></i></div>\n\t\t\t\t</div>\n\t\t\t`,e("#epie-content-export .epie-progress__bar").hide()),m.info.error&&(i+=`\n\t\t\t\t<div class="epie-export-progress__row epie-export-progress__row--error">\n\t\t\t\t\t<div class="epie-export__title">${m.info.error}</div>\n\t\t\t\t\t<div class="epie-export__icon"><i class="epkbfa epkbfa-exclamation-circle"></i></div>\n\t\t\t\t</div>\n\t\t\t`,e("#epie-content-export  .epie-progress__bar").hide()),m.info.in_progress){if(e("#epie-content-export .epie-progress__bar").show(),Object.keys(m.data).length)for(let e in m.data){i+='<div class="epie-export-progress__row epie-export-progress__row--',0==m.data[e].ids.length?i+="finished":m.data[e].active?i+="in-progress":i+="wait",i+='">';let n=m.data[e].text;i+=`<div class="epie-export__title">${n=n.replace("$count",m.data[e].total-m.data[e].ids.length+"/"+m.data[e].total)}</div>`,0==m.data[e].ids.length?i+='<div class="epie-export__icon"><i class="epkbfa epkbfa-check-circle"></i></div>':m.data[e].active?i+='<div class="epie-export__icon"><i class="epkbfa epkbfa-spinner"></i></div>':i+='<div class="epie-export__icon"><i class="epkbfa epkbfa-pause-circle"></i></div>',i+="</div>",t+=m.data[e].total,o+=m.data[e].total-m.data[e].ids.length}else if(!m.info.error){i+=`\n\t\t\t\t\t<div class="epie-export-progress__row epie-export-progress__row--in-progress">\n\t\t\t\t\t\t<div class="epie-export__title">${e("#epie-content-export .epie-progress").data("start")}</div>\n\t\t\t\t\t\t<div class="epie-export__icon"><i class="epkbfa epkbfa-spinner"></i></div>\n\t\t\t\t\t</div>`}t?e("#epie-content-export .epie-progress__bar div").css({width:100*o/t+"%"}):e("#epie-content-export .epie-progress__bar div").css({width:"0%"}),m.info.file?(e("#export_file_link").attr("href",m.info.file),e("#export_file_link").show()):e("#export_file_link").hide()}else e("#epie-content-export .epie-progress__bar").hide();e("#epie-content-export .epie-progress__log").html(i)}function s(){if(!Object.keys(m.data).length||m.info.error)m.info.in_progress=!1,a();else{for(let e in m.data)m.data[e].active=!1;let t=[],o="finish";for(let e in m.data)if(m.data[e].ids.length){m.data[e].active=!0,t=m.data[e].ids.slice(-m.info.items_per_request),o=e;break}let n={_wpnonce_kb_import_export:e("#_wpnonce_kb_import_export").val(),action:"epie_make_step",type:o,ids:t,file_id:m.user_data.file_id,epie_kb_id:e("input[name=epie_kb_id]").val(),description:m.user_data.description,tag:m.user_data.tag};e.ajax({type:"POST",dataType:"json",data:n,url:ajaxurl,beforeSend:function(e){a()}}).done(function(e){"finish"!==o&&t&&"success"==e.status&&m.data[o].ids.splice(-m.info.items_per_request,m.info.items_per_request),e.success&&(m.info.success=e.success),e.error&&(m.info.error=e.error),e.file&&(m.info.file=e.file),a(),t.length&&s()}).fail(function(e,t,o){if(m.info.items_per_request>1)m.info.items_per_request--,s();else{let e=o?" ["+o+"]":"unknown error";if(""!==e)return void i(e,"error")}})}}function p(){if(f.length){let i={action:"epie_kb_export_article_pack",ids:f[f.length-1]};e.ajax({_wpnonce_kb_import_export:e("#_wpnonce_kb_import_export").val(),type:"GET",dataType:"json",data:i,url:ajaxurl,beforeSend:function(e){}}).done(function(i){"success"==i.status&&(f.pop(),e("#epie-content-export .epie-export-log").append(`Done, ${f.length} left <br>`)),p()})}else{let i={action:"epie_kb_export_get_json"};e.ajax({_wpnonce_kb_import_export:e("#_wpnonce_kb_import_export").val(),type:"GET",dataType:"json",data:i,url:ajaxurl,beforeSend:function(e){}}).done(function(i){e(".epie-export-json").append(`<a href="${i.link}" target="_blank">Get JSON</a><br>`)}),i={action:"epie_kb_export_get_csv",clear:1},e.ajax({_wpnonce_kb_import_export:e("#_wpnonce_kb_import_export").val(),type:"GET",dataType:"json",data:i,url:ajaxurl,beforeSend:function(e){}}).done(function(i){e(".epie-export-json").append(`<a href="${i.link}" target="_blank">Get CSV</a>`)})}}function d(e){u=0,c(e),e.find(".epie-data-status-log").html(""),e.find("#kb_post_link").hide(),e.find("input[name=import_file]").val(""),e.find('input[name="import_file"]').prop("disabled",!1),e.find("#epie-submit-prepare-action").show(),e.find("#epie-submit-import-action").hide(),e.find("#epie-submit-start-over-action").hide(),e.find(".epie-progress").hide(),e.find("input[name=import_action]").val("prepare-kb-import"),e.parent().find(".epie-import-steps__single-step").removeClass("epie-import-steps__single-step--active"),e.parent().find("#epie-step-1").addClass("epie-import-steps__single-step--active"),e.find(".epie-form-field-wrap").show(),e.find(".epie-form-field-intruction-wrap").show(),e.find(".epie-form-field-intruction-wrap").show(),e.parent().parent().find(".epie-form-field-intruction-wrap").show(),e.find(".epie-progress__bar").removeClass("epie-progress__bar-in-progress"),"undefined"!=typeof interval&&clearInterval(interval)}function _(i,t){return b&&void 0!==i.processed?(b=!1,void setTimeout(function(){!function(i,t,o,n){e(".epie-admin-dialog-box-status").remove(),e(".epie-admin-dialog-box-loading").remove(),e(".epie-admin-dialog-box-confirmation").remove(),e(".epie-admin-dialog-box-info").remove();let r=`\n\t\t\t<div class="epie-admin-dbc__footer">\n\t\t\t\t<div class="epie-admin-dbc__footer__accept">\n\t\t\t\t\t<span class="epie-admin-dbc__footer__accept__btn epie-dbc__footer__accept--success">${epie_vars.msg_ok}</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`,a='<div class="epie-admin-dialog-box-info"><div class="epie-admin-dbc__header">'+(i?"<h4>"+i+"</h4>":"")+'</div><div class="epie-admin-dbc__body">'+(t||"")+"</div>"+r+"</div>";e("body").append(a),e("body").one("click",function(){"function"==typeof o&&o(n),e(".epie-admin-dialog-box-info").remove()})}(epie_vars.msg_content_import,epie_vars.msg_imported_articles+i.processed,d,t)},100)):"object"==typeof i&&void 0!==i.error?(t.find("#epie-submit-start-over-action").show(),e("#epie-cancel-action").hide(),void t.find(".epie-progress__log").html(`\n\t\t\t\t<div class="epie-export-progress__row epie-export-progress__row--error">\n\t\t\t\t\t<div class="epie-export__icon"><i class="epkbfa epkbfa-exclamation-circle"></i></div>\n\t\t\t\t\t<div class="epie-export__title">${i.error}</div>\n\t\t\t\t</div>\n\t\t\t`)):null!=i&&void 0!=i.success&&""!=i.success?(t.find(".epie-progress__bar div").css({width:"100%"}),e("#epie-cancel-action").hide(),t.find(".epie-progress__log").html(i.success),t.find(".epie-data-status-log").html(i.response_html),t.find(".epie-progress__bar").removeClass("epie-progress__bar-in-progress"),t.find("input[name=import_action]").val("prepare-kb-import"),t.find("#kb_post_link").show(),t.find('input[name="import_file"]').prop("disabled",!1),t.find(".epie-form-label__input--submit").hide(),t.find("#epie-submit-import-action").hide(),t.find("#epie-submit-start-over-action").show(),void(u=i.inserted)):(null!=i&&void 0!=i.process_message&&""!=i.process_message&&(t.find(".epie-progress__log .epie-export-progress__row--in-progress .epie-export__title").html(`\n\t\t\t\t${i.process_message}\n\t\t\t`),t.find(".epie-progress__bar-in-progress div").css({width:i.progress+"%"}),u=i.processed),void(v?function(i){v--,e.ajax({type:"POST",dataType:"json",data:{action:"epie_import_steps"},url:ajaxurl,beforeSend:function(e){}}).done(function(e){_(e,i)})}(t):(t.find("#epie-submit-start-over-action").show(),t.find(".epie-progress__log").html('\n\t\t\t\t<div class="epie-export-progress__row epie-export-progress__row--error">\n\t\t\t\t\t<div class="epie-export__icon"><i class="epkbfa epkbfa-exclamation-circle"></i></div>\n\t\t\t\t\t<div class="epie-export__title">The import file is too big.</div>\n\t\t\t\t</div>\n\t\t\t'))))}function c(e){let i=e.find(".epie-progress").data("start");e.find(".epie-progress__log").html(`\n\t\t\t<div class="epie-export-progress__row epie-export-progress__row--in-progress">\n\t\t\t\t<div class="epie-export__title">${i}</div>\n\t\t\t\t<div class="epie-export__icon"><i class="epkbfa epkbfa-spinner"></i></div>\n\t\t\t</div>\n\t\t`)}e("#epie-ajax-in-progress").dialog({resizable:!1,height:70,width:200,modal:!1,autoOpen:!1}).hide(),e(".epie-admin-dbc__close").on("click",function(){e(".epie-admin-dialog-box-confirmation").hide(),e(".epie-admin-dialog-box-info").remove()}),e(".epie-admin-dbc__footer__cancel").on("click",function(){e(".epie-admin-dialog-box-confirmation").hide(),e(".epie-admin-dialog-box-info").remove()}),e(".epie-tm-dbf__close").on("click",function(){e(".epie-tm-dialog-box-form").hide()}),e(".epie-tm-dbf__footer__cancel").on("click",function(){e(".epie-tm-dialog-box-form").hide()});let l=e("#ekcb-licenses");e("#eckb_license_tab").hasClass("active")&&t(),e("#wpbody").on("click","#eckb_license_tab",function(e){t()}),l.on("click","#epie_save_btn",function(i){i.preventDefault();o("POST",{action:"epie_handle_license_request",epie_license_key:e("#epie_license_key").val().trim(),_wpnonce_epie_license_key:e("#_wpnonce_epie_license_key").val(),command:"save"},"Saving license...")});let f=[],m={data:{},info:{items_per_request:5,success:"",error:"",in_progress:!1,file:"",file_id:""},user_data:{}};e("#epie-start-export-kb-btn").click(function(){e("#epie-content-export .epie-export-log").append("Get Article list <br>"),e.ajax({_wpnonce_kb_import_export:e("#_wpnonce_kb_import_export").val(),type:"GET",dataType:"json",data:{action:"epie_kb_get_article_ids"},url:ajaxurl,beforeSend:function(e){}}).done(function(i){e("#epie-content-export .epie-export-log").append("Done <br>"),i.data&&(f=i.data,p())})}),e("#export-main-form").submit(function(){return e(".epie-dialog-box-form").toggleClass("epie-dialog-box-form--active"),!1}),e(".epie-dbf__footer__cancel__btn, .epie-dbf__close").on("click",function(){e(this).parents(".epie-dialog-box-form").removeClass("epie-dialog-box-form--active")}),e("#epie-export-form #epie-accept-button").on("click",function(){e(this).parents(".epie-dialog-box-form").removeClass("epie-dialog-box-form--active"),e("#epie-content-export .epie-progress").show(),function(){let i={_wpnonce_kb_import_export:e("#_wpnonce_kb_import_export").val(),action:"epie_get_export_data",form:e("#export-main-form").serialize()};e.ajax({type:"POST",dataType:"json",data:i,url:ajaxurl,beforeSend:function(i){m.data={},m.info.success="",m.info.error="",m.info.file="",m.user_data.file_id="",m.info.in_progress=!0,m.user_data={},a(),e("#epie-content-export .epie-progress").show()}}).done(function(e){e.error?(m.info.error=e.error,a()):e.data&&(m.data=e.data,m.user_data.tag=e.tag,m.user_data.description=e.description,m.user_data.file_id=e.file_id,s())})}()}),e(".epie-top-panel__button").click(function(){e(".epie-top-panel__button").removeClass("epie-top-panel__button--active"),e(this).addClass("epie-top-panel__button--active"),e(".epie-content").removeClass("epie-content--active"),e(e(this).data("target")).addClass("epie-content--active")});let u=0,v=1e3,b=!1;e(".epie-import-content-form form").submit(function(i){i.preventDefault(),b=!1;let t=e(this);if("epie-submit-start-over-action"==i.originalEvent.submitter.id)return void d(t);const o=t.find("input[name=import_file]")[0].files[0],n=new FileReader;n.readAsText(o,"UTF-8"),n.onload=function(i){t.find('input[name="import_file"]').prop("disabled",!0),t.parents(".epkb-admin-row").addClass("epie-admin-row--import-kb-articles");let o="",n=new FormData;if(n.append("file",t.find("input[name=import_file]")[0].files[0]),n.append("_wpnonce_kb_import_export",t.find("#_wpnonce_kb_import_export").val()),n.append("epie_kb_id",t.find("input[name=epie_kb_id]").val()),n.append("import_action",t.find("input[name=import_action]").val()),n.append("action","epie_import_kb_content"),"prepare-kb-import"==t.find("input[name=import_action]").val())t.find("#epie-submit-prepare-action").hide(),t.find("#kb_post_link").hide(),t.parent().find(".epie-import-steps__single-step").removeClass("epie-import-steps__single-step--active"),t.parent().find("#epie-step-2").addClass("epie-import-steps__single-step--active"),t.find(".epie-form-field-wrap").hide(),t.find(".epie-form-field-intruction-wrap").hide(),t.parent().parent().find(".epie-form-field-intruction-wrap").hide(),c(t);else{if("import_data"!=t.find("input[name=import_action]").val())return;{t.find("#epie-submit-import-action").hide(),t.find("#epie-submit-start-over-action").hide(),t.parent().find(".epie-import-steps__single-step").removeClass("epie-import-steps__single-step--active"),t.parent().find("#epie-step-3").addClass("epie-import-steps__single-step--active");let i=[];t.find("input[name=csv_row]:checked").each(function(){i.push(e(this).val())}),n.append("selected_rows",JSON.stringify(i)),v=1e3,t.find(".epie-progress__bar").addClass("epie-progress__bar-in-progress"),c(t),t.find(".epie-progress__log .epie-export-progress__row--in-progress .epie-export__title").html(`\n\t\t\t\t\t${epie_vars.msg_0_imported} ${i.length}...\n\t\t\t\t`)}}t.find(".epie-progress").show(),t.find(".epie-progress__bar div").css({width:"0%"}),t.find(".epie-data-status-log").html(""),e.ajax({_wpnonce_kb_import_export:e(this).find("#_wpnonce_kb_import_export").val(),type:"POST",dataType:"json",data:n,url:ajaxurl,processData:!1,contentType:!1,beforeSend:function(i){"import_data"==t.find("input[name=import_action]").val()&&e("#epie-cancel-action").show()}}).done(function(e){if(""==(e=e||"")||"undefined"===e.success&&"undefined"===e.error&&"undefined"===e.process_message)return o=e.message?e.message:r("",epie_vars.msg_admin_error_l01,"error"),void t.find(".epie-data-status-log").html(o);void 0!=e.success&&""!=e.success&&"prepare-kb-import"==t.find("input[name=import_action]").val()?(t.find(".epie-progress__log").html(e.success),t.find(".epie-data-status-log").html(e.response_html),t.find(".epie-progress__bar div").css({width:"100%"}),t.find("input[name=import_action]").val("import_data"),t.find('input[name="import_file"]').prop("disabled",!0),t.find("#epie-submit-prepare-action").hide(),t.find("#epie-submit-import-action").show(),t.find("#epie-submit-start-over-action").show()):"import_data"==t.find("input[name=import_action]").val()?_(e,t):(t.find("#epie-submit-start-over-action").show(),t.find(".epie-progress__log").html(`\n\t\t\t\t\t<div class="epie-export-progress__row epie-export-progress__row--error">\n\t\t\t\t\t\t<div class="epie-export__icon"><i class="epkbfa epkbfa-exclamation-circle"></i></div>\n\t\t\t\t\t\t<div class="epie-export__title">${e.error}</div>\n\t\t\t\t\t</div>\n\t\t\t\t`)),void 0!==e.inserted&&e.inserted&&(u=e.inserted)}).fail(function(e,i,n){o=n?" ["+n+"]":"unknown error",o=r("",epie_vars.msg_admin_error_l012,"error"),t.find(".epie-data-status-log").html(o)})},n.onerror=function(e){t.find("input[name=import_file]").val(""),d(t),t.find(".epie-progress").show(),t.find(".epie-progress__log").html('\n\t\t\t\t\t<div class="epie-export-progress__row epie-export-progress__row--error">\n\t\t\t\t\t\t<div class="epie-export__icon"><i class="epkbfa epkbfa-exclamation-circle"></i></div>\n\t\t\t\t\t\t<div class="epie-export__title">Your CSV file has changed. Please reselect the file and start again.</div>\n\t\t\t\t\t</div>\n\t\t\t\t'),console.log(e)}}),e("#epie-cancel-action").click(function(){return b=!0,e("body").find(".epie-export__title").html(epie_vars.msg_stop_import),e(this).hide(),!1})});